services:
  api:
    build:
      context: ..
      dockerfile: build/Dockerfile
    ports:
      - "${PPROF_PORT:-6060}:6060"
    environment:
      PPROF_PORT: 6060
    volumes:
      - ..:/app:ro

  test:
    image: golang:1.25-alpine
    working_dir: /app
    volumes:
      - ..:/app
    profiles:
      - test
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/orders?sslmode=disable
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - orders-network
    command: go test -v ./...
